{% extends 'base/api_base.html' %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - Razgon{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8" x-data="dashboardData()">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                <span x-text="user ? `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.first_name}!` : '–ó–∞–≥—Ä—É–∑–∫–∞...'"></span>
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏ –∏ –≤–µ–¥–∏—Ç–µ —É—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤
            </p>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="mt-8">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-3">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ -->
            <div class="overflow-hidden rounded-lg bg-white shadow">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-md bg-indigo-500 flex items-center justify-center">
                                <span class="text-lg">üöó</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="stats.cars_count || 0"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-5 py-3">
                    <div class="text-sm">
                        <a href="/garage/" class="font-medium text-indigo-600 hover:text-indigo-500">
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏
                        </a>
                    </div>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ó–∞–º–µ—Ç–∫–∏ -->
            <div class="overflow-hidden rounded-lg bg-white shadow">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-md bg-green-500 flex items-center justify-center">
                                <span class="text-lg">üìù</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">–ó–∞–º–µ—Ç–∫–∏</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="stats.notes_count || 0"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-5 py-3">
                    <div class="text-sm">
                        <a href="/notes/" class="font-medium text-green-600 hover:text-green-500">
                            –í—Å–µ –∑–∞–º–µ—Ç–∫–∏
                        </a>
                    </div>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –†–∞—Å—Ö–æ–¥—ã -->
            <div class="overflow-hidden rounded-lg bg-white shadow">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-md bg-yellow-500 flex items-center justify-center">
                                <span class="text-lg">üí∞</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">–†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="stats.monthly_expenses + ' ‚ÇΩ' || '0 ‚ÇΩ'"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-5 py-3">
                    <div class="text-sm">
                        <a href="/expenses/" class="font-medium text-yellow-600 hover:text-yellow-500">
                            –û—Ç—á–µ—Ç—ã
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
                    –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </h3>
                
                <div id="profile-content">
                    <div x-show="!editingProfile" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ò–º—è</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="user?.first_name || '–ó–∞–≥—Ä—É–∑–∫–∞...'"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–§–∞–º–∏–ª–∏—è</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="user?.last_name || '–ó–∞–≥—Ä—É–∑–∫–∞...'"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="user?.email || '–ó–∞–≥—Ä—É–∑–∫–∞...'"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="user?.username || '–ó–∞–≥—Ä—É–∑–∫–∞...'"></p>
                        </div>
                        <div x-show="user?.date_joined">
                            <label class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatDate(user?.date_joined)"></p>
                        </div>
                    </div>

                    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
                    <div x-show="editingProfile" class="space-y-4">
                        <div id="profile-error-messages"></div>
                        
                        <div>
                            <label for="edit_first_name" class="block text-sm font-medium text-gray-700">–ò–º—è</label>
                            <div class="mt-1">
                                <input id="edit_first_name" 
                                       type="text" 
                                       x-model="editForm.first_name"
                                       class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <div>
                            <label for="edit_last_name" class="block text-sm font-medium text-gray-700">–§–∞–º–∏–ª–∏—è</label>
                            <div class="mt-1">
                                <input id="edit_last_name" 
                                       type="text" 
                                       x-model="editForm.last_name"
                                       class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <div>
                            <label for="edit_email" class="block text-sm font-medium text-gray-700">Email</label>
                            <div class="mt-1">
                                <input id="edit_email" 
                                       type="email" 
                                       x-model="editForm.email"
                                       class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button @click="updateProfile()" 
                                    :disabled="profileLoading"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                                <span x-show="profileLoading" class="mr-2">
                                    <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                            
                            <button @click="cancelEdit()" 
                                    type="button" 
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                </div>

                <div x-show="!editingProfile" class="mt-6">
                    <button @click="startEdit()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-600 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                </div>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
                    –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </h3>
                
                <div class="space-y-4">
                    <a href="/garage/add/" class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="mr-2">üöó</span>
                        –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å
                    </a>
                    
                    <button class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="mr-2">üìù</span>
                        –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
                    </button>
                    
                    <button class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="mr-2">‚õΩ</span>
                        –ó–∞–ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–∞–≤–∫—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="mt-8">
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
                    –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
                </h3>
                
                <div x-show="recentActions.length === 0" class="text-center py-12">
                    <div class="mx-auto h-12 w-12 text-gray-400">
                        <span class="text-4xl">üìã</span>
                    </div>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        –ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏ –∑–∞–º–µ—Ç–∫–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–¥–µ—Å—å.
                    </p>
                </div>

                <div x-show="recentActions.length > 0" class="space-y-4">
                    <template x-for="action in recentActions" :key="action.id">
                        <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                            <div class="flex-shrink-0">
                                <span x-text="action.icon" class="text-2xl"></span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900" x-text="action.title"></p>
                                <p class="text-sm text-gray-500" x-text="action.description"></p>
                                <p class="text-xs text-gray-400" x-text="formatDate(action.created_at)"></p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function dashboardData() {
        return {
            user: null,
            stats: {
                cars_count: 0,
                notes_count: 0,
                monthly_expenses: 0
            },
            recentActions: [],
            editingProfile: false,
            profileLoading: false,
            editForm: {
                first_name: '',
                last_name: '',
                email: ''
            },

            async init() {
                await this.loadUserProfile();
                await this.loadStats();
                await this.loadRecentActions();
            },

            async loadUserProfile() {
                try {
                    this.user = await window.api.get('/api/auth/api/profile/');
                } catch (error) {
                    console.error('Failed to load user profile:', error);
                }
            },

            async loadStats() {
                try {
                    // –ü–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫–∞, –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–∞–ª—å–Ω–æ–µ API
                    this.stats = {
                        cars_count: 0,
                        notes_count: 0,
                        monthly_expenses: 0
                    };
                } catch (error) {
                    console.error('Failed to load stats:', error);
                }
            },

            async loadRecentActions() {
                try {
                    // –ü–æ–∫–∞ —á—Ç–æ –∑–∞–≥–ª—É—à–∫–∞, –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–∞–ª—å–Ω–æ–µ API
                    this.recentActions = [];
                } catch (error) {
                    console.error('Failed to load recent actions:', error);
                }
            },

            startEdit() {
                this.editForm = {
                    first_name: this.user.first_name,
                    last_name: this.user.last_name,
                    email: this.user.email
                };
                this.editingProfile = true;
                document.getElementById('profile-error-messages').innerHTML = '';
            },

            cancelEdit() {
                this.editingProfile = false;
                document.getElementById('profile-error-messages').innerHTML = '';
            },

            async updateProfile() {
                this.profileLoading = true;
                
                try {
                    const response = await fetch('/api/auth/api/update_profile/', {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + getAuthToken(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.editForm)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.user = data.user;
                        this.editingProfile = false;
                        window.showMessage('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                    } else {
                        this.showProfileErrors(data);
                    }
                } catch (error) {
                    console.error('Profile update error:', error);
                    this.showProfileError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.');
                } finally {
                    this.profileLoading = false;
                }
            },

            showProfileErrors(errors) {
                let errorHtml = '<div class="rounded-md bg-red-50 border border-red-200 p-4 mb-4"><div class="text-sm text-red-700">';
                
                for (const [field, fieldErrors] of Object.entries(errors)) {
                    const fieldName = {
                        'email': 'Email',
                        'first_name': '–ò–º—è',
                        'last_name': '–§–∞–º–∏–ª–∏—è'
                    }[field] || field;

                    if (Array.isArray(fieldErrors)) {
                        fieldErrors.forEach(error => {
                            errorHtml += `<p><strong>${fieldName}:</strong> ${error}</p>`;
                        });
                    }
                }
                
                errorHtml += '</div></div>';
                document.getElementById('profile-error-messages').innerHTML = errorHtml;
            },

            showProfileError(message) {
                document.getElementById('profile-error-messages').innerHTML = `
                    <div class="rounded-md bg-red-50 border border-red-200 p-4 mb-4">
                        <div class="text-sm text-red-700">${message}</div>
                    </div>
                `;
            },

            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU');
            }
        }
    }
</script>
{% endblock %}
